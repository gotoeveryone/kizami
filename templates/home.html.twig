{% extends "layout/base.html.twig" %}

{% block title %}Kizami - ç¨¼åƒæ™‚é–“{% endblock %}

{% block body %}
    <h1>ç¨¼åƒæ™‚é–“ç®¡ç†</h1>

    {% if saved %}
        <article class="notice-success">ä¿å­˜ã—ã¾ã—ãŸã€‚</article>
    {% endif %}
    {% if updated %}
        <article class="notice-success">æ›´æ–°ã—ã¾ã—ãŸã€‚</article>
    {% endif %}
    {% if deleted %}
        <article class="notice-success">å‰Šé™¤ã—ã¾ã—ãŸã€‚</article>
    {% endif %}

    {% if errors %}
        {% for error in errors %}
            <article class="notice-error">{{ error }}</article>
        {% endfor %}
    {% endif %}

    <h2>è¡¨ç¤ºæ¡ä»¶</h2>
    <form method="get" action="/">
        <label for="date_from">å¯¾è±¡æœŸé–“ï¼ˆFromï¼‰</label>
        <input id="date_from" type="date" name="date_from" value="{{ filterDateFrom }}">

        <label for="date_to">å¯¾è±¡æœŸé–“ï¼ˆToï¼‰</label>
        <input id="date_to" type="date" name="date_to" value="{{ filterDateTo }}">

        <label for="filter_client_id">ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ</label>
        <select id="filter_client_id" name="client_id">
            <option value="">ã™ã¹ã¦</option>
            {% for client in clients %}
                <option value="{{ client.id }}" {% if filterClientId == client.id %}selected{% endif %}>
                    {{ client.name }}
                </option>
            {% endfor %}
        </select>

        <button type="submit">çµã‚Šè¾¼ã¿</button>
    </form>

    <article>
        <strong>{{ filterDateFrom }} ã€œ {{ filterDateTo }} åˆè¨ˆ:</strong> {{ monthlyTotal }}h
    </article>

    <details class="register-panel" {% if errors %}open{% endif %}>
        <summary>
            <span class="closed-label">ï¼‹ ç¨¼åƒæ™‚é–“ã‚’ç™»éŒ²ï¼ˆã‚¯ãƒªãƒƒã‚¯ã§é–‹ãï¼‰</span>
            <span class="open-label">âˆ’ ç¨¼åƒæ™‚é–“ã‚’ç™»éŒ²ï¼ˆã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹ï¼‰</span>
        </summary>
        <form method="post" action="/time-entries">
            {% include "partials/csrf_fields.html.twig" %}
            <label for="date">æ—¥ä»˜</label>
            <input id="date" type="date" name="date" value="{{ old.date }}" required>

            <label for="client_id">ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ</label>
            <select id="client_id" name="client_id" required>
                <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                {% for client in clients %}
                    <option value="{{ client.id }}" {% if old.client_id == client.id %}selected{% endif %}>
                        {{ client.name }}
                    </option>
                {% endfor %}
            </select>

            <label for="work_category_id">ä½œæ¥­åˆ†é¡</label>
            <select id="work_category_id" name="work_category_id" required>
                <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                {% for category in workCategories %}
                    <option value="{{ category.id }}" {% if old.work_category_id == category.id %}selected{% endif %}>
                        {{ category.name }}
                    </option>
                {% endfor %}
            </select>

            <label for="start_time">é–‹å§‹</label>
            <select id="start_time" name="start_time" required>
                {% for time in timeOptions %}
                    <option value="{{ time }}" {% if old.start_time == time %}selected{% endif %}>{{ time }}</option>
                {% endfor %}
            </select>

            <label for="end_time">çµ‚äº†</label>
            <select id="end_time" name="end_time" required>
                {% for time in timeOptions %}
                    <option value="{{ time }}" {% if old.end_time == time %}selected{% endif %}>{{ time }}</option>
                {% endfor %}
            </select>

            <label for="comment">ã‚³ãƒ¡ãƒ³ãƒˆ</label>
            <textarea id="comment" name="comment" rows="3">{{ old.comment }}</textarea>

            <button type="submit">ä¿å­˜</button>
        </form>
    </details>

    <h2>ç¨¼åƒå±¥æ­´ï¼ˆ{{ filterDateFrom }} ã€œ {{ filterDateTo }}ï¼‰</h2>
    {% if timeEntries %}
        <table>
            <thead>
            <tr>
                <th>ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ</th>
                <th>ä½œæ¥­åˆ†é¡</th>
                <th>é–‹å§‹</th>
                <th>çµ‚äº†</th>
                <th>æ™‚é–“</th>
                <th>ã‚³ãƒ¡ãƒ³ãƒˆ</th>
                <th>æ“ä½œ</th>
            </tr>
            </thead>
            <tbody>
            {% set groupDate = '' %}
            {% for entry in timeEntries %}
                {% if groupDate != entry.date %}
                    {% set groupDate = entry.date %}
                    <tr class="group-row">
                        <td colspan="7">
                            <strong>{{ groupDate }}</strong>
                            <small>ï¼ˆåˆè¨ˆ {{ dailyTotalsByDate[groupDate]|default(0) }}hï¼‰</small>
                        </td>
                    </tr>
                {% endif %}
                <tr>
                    <td>{{ entry.client_name }}</td>
                    <td>{{ entry.work_category_name }}</td>
                    <td>{{ entry.start_time|slice(0, 5) }}</td>
                    <td>{{ entry.end_time|slice(0, 5) }}</td>
                    <td>{{ entry.hours }}</td>
                    <td class="comment-cell">{{ entry.comment ?: '-' }}</td>
                    <td>
                        <div class="action-buttons">
                            <a
                                href="/time-entries/{{ entry.id }}/edit"
                                role="button"
                                class="secondary outline icon-button"
                                aria-label="ç·¨é›†"
                                title="ç·¨é›†"
                            >âœ</a>
                            <form method="post" action="/time-entries/{{ entry.id }}/delete">
                                {% include "partials/csrf_fields.html.twig" %}
                                <button
                                    type="submit"
                                    class="outline icon-button"
                                    onclick="return confirm('å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ');"
                                    aria-label="å‰Šé™¤"
                                    title="å‰Šé™¤"
                                >ğŸ—‘</button>
                            </form>
                        </div>
                    </td>
                </tr>
            {% endfor %}
            </tbody>
        </table>
    {% else %}
        <p>ã¾ã ç™»éŒ²ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>
    {% endif %}
{% endblock %}
